name: Build Minimal x86 Image

on:
  workflow_dispatch:
    inputs:
      landscape_version:
        description: "Landscape version (latest or tag)"
        default: "latest"
      include_docker:
        description: "Include Docker"
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - build.sh
      - build.env
      - rootfs/**
      - configs/**
      - .github/workflows/**

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize build space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap qemu-utils parted dosfstools e2fsprogs grub-efi-amd64-bin grub-pc-bin rsync curl

      - name: Build Image
        run: |
          DOCKER_FLAG=""
          if [ "${{ github.event.inputs.include_docker }}" = "true" ]; then
            DOCKER_FLAG="--with-docker"
          fi
          VERSION="${{ github.event.inputs.landscape_version || 'latest' }}"
          sudo ./build.sh --version "$VERSION" $DOCKER_FLAG

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts
          cp output/*.img artifacts/ 2>/dev/null || true
          cp output/*.vmdk artifacts/ 2>/dev/null || true
          cp output/*.gz artifacts/ 2>/dev/null || true
          ls -lh artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: landscape-mini-x86
          path: artifacts/
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: landscape-mini-x86
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
