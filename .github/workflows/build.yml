name: Build Minimal x86 Image

on:
  workflow_dispatch:
    inputs:
      landscape_version:
        description: "Landscape version (latest or tag)"
        default: "latest"
      include_docker:
        description: "Include Docker"
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - build.sh
      - build.env
      - rootfs/**
      - configs/**
      - .github/workflows/**

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize build space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap qemu-utils parted dosfstools e2fsprogs grub-efi-amd64-bin grub-pc-bin rsync curl

      - name: Build Image
        run: |
          DOCKER_FLAG=""
          if [ "${{ github.event.inputs.include_docker }}" = "true" ]; then
            DOCKER_FLAG="--with-docker"
          fi
          VERSION="${{ github.event.inputs.landscape_version || 'latest' }}"
          sudo APT_MIRROR="" ./build.sh --version "$VERSION" $DOCKER_FLAG

      - name: List outputs
        run: ls -lh output/

      - name: Upload raw image
        if: hashFiles('output/*.img') != ''
        uses: actions/upload-artifact@v4
        with:
          name: landscape-mini-x86-img
          path: output/*.img
          retention-days: 30

      - name: Upload compressed raw image
        if: hashFiles('output/*.img.gz') != ''
        uses: actions/upload-artifact@v4
        with:
          name: landscape-mini-x86-img-gz
          path: output/*.img.gz
          retention-days: 30

      - name: Upload VMDK image
        if: hashFiles('output/*.vmdk') != ''
        uses: actions/upload-artifact@v4
        with:
          name: landscape-mini-x86-vmdk
          path: output/*.vmdk
          retention-days: 30

      - name: Upload compressed VMDK image
        if: hashFiles('output/*.vmdk.gz') != ''
        uses: actions/upload-artifact@v4
        with:
          name: landscape-mini-x86-vmdk-gz
          path: output/*.vmdk.gz
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: landscape-mini-x86-*
          path: artifacts/
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
